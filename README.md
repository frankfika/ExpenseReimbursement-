# 报销助手

> 一款基于 AI 的智能发票识别与报销整理工具，让报销从此告别繁琐。

**现在支持网页版！** 上传发票 → 自动处理 → 下载 ZIP 结果

---

## 它能帮你做什么？

每次出差回来，面对一堆发票是不是很头疼？打车票、火车票、酒店发票、餐饮发票混在一起，还要一张张核对金额、分类整理、制作报销单...

**报销助手**帮你自动完成这一切：

1. **扔进去** — 把所有发票扔到一个文件夹
2. **跑一下** — 双击运行，喝杯咖啡
3. **拿结果** — 分类好的文件夹 + Excel 统计表

---

## 核心功能

### 🔍 智能识别
- 支持图片（JPG/PNG）和 PDF 格式
- 自动识别扫描件和电子发票
- 提取发票金额、日期、商家、发票号等关键信息

### 📂 自动分类
| 类别 | 识别范围 |
|:---:|:---|
| 🚕 打车票 | 滴滴、高德、美团打车、曹操、首汽、出租车 |
| 🚄 火车飞机票 | 12306、各航空公司、携程、飞猪 |
| 🏨 住宿费 | 酒店、宾馆、民宿（如家、汉庭、亚朵等） |
| 🍜 餐费 | 餐厅、外卖、美团、饿了么 |
| 📦 其他 | 未能识别的发票 |

### 🔗 智能配对
出差打车经常会有「行程单 + 发票」两份文件，系统会自动配对：
- 识别同一平台的凭证和发票
- 匹配相近日期（±1天）
- 匹配相近金额（±5%）
- 配对后放入同一文件夹，方便核对

### 📝 清晰命名
告别 `IMG_20240115_123456.jpg` 这样的文件名，自动重命名为：
```
2024-01-15_发票_滴滴出行_35.00元_望京-三里屯.pdf
```

### 📊 报表生成
自动生成 Excel 报表：
- 汇总表：各类别小计 + 总金额
- 明细表：每张发票的详细信息
- 直接用于报销，无需二次整理

---

## 快速开始

### 第一步：安装依赖

```bash
pip3 install -r requirements.txt
```

> 首次安装需要下载 OCR 模型，可能需要几分钟。

### 第二步：首次运行配置

直接运行程序，首次会自动引导你配置：

```
============================================================
🎉 欢迎使用报销助手！
============================================================

首次使用需要配置 API Key，只需配置一次，之后就不用再填了。

📖 获取 API Key 步骤：
------------------------------------------------------------
1. 打开硅基流动官网注册/登录：
   👉 https://cloud.siliconflow.cn/i/Wd45d1wI
   （使用此邀请链接注册可获得额外额度）

2. 登录后，点击左侧菜单「API 密钥」
3. 点击「新建 API 密钥」，复制生成的密钥
------------------------------------------------------------

请粘贴你的 API Key（输入后按回车）：
```

> 粘贴你的 API Key 后按回车，配置会自动保存，以后运行就不用再填了！

### 第三步：开始使用

有三种使用方式，选择你喜欢的：

---

## 使用方式一：网页版（最简单）

最友好的方式，打开浏览器就能用！

### 启动网页服务

```bash
# 方式 A：双击启动
双击 启动网页版.command

# 方式 B：命令行启动
python3 web_app.py
```

浏览器会自动打开 `http://localhost:5000`

### 使用步骤

1. **上传发票**
   - 拖拽文件或文件夹到上传区域
   - 或点击「选择文件」/「选择文件夹」按钮
   - 支持 JPG、PNG、PDF 格式

2. **等待处理**
   - 点击「开始处理」
   - 页面会显示实时进度
   - 处理完成后显示费用汇总

3. **下载结果**
   - 点击「下载报销结果 (ZIP)」
   - ZIP 包含分类好的文件夹 + Excel 报表
   - 下载后服务器自动删除你的文件（保护隐私）

### 网页版截图

```
┌─────────────────────────────────────────────────┐
│              📋 报销助手                         │
│     上传发票，自动识别分类，一键下载整理结果       │
├─────────────────────────────────────────────────┤
│                                                 │
│         ┌─────────────────────────┐            │
│         │                         │            │
│         │    拖拽发票文件或       │            │
│         │    文件夹到这里         │            │
│         │                         │            │
│         │  [选择文件] [选择文件夹] │            │
│         └─────────────────────────┘            │
│                                                 │
│         已选择的文件 (5)                        │
│         ├── 滴滴发票.pdf                        │
│         ├── 火车票.jpg                          │
│         └── ...                                │
│                                                 │
│         [清空]  [开始处理]                       │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 使用方式二：双击启动（命令行交互）

适合习惯命令行的用户，功能更完整。

1. 双击 `启动报销助手.command`
2. 把发票文件夹拖进终端窗口
3. 按回车，选择处理方式
4. 等待完成，打开结果

---

## 使用方式三：纯命令行

适合脚本化、自动化场景。

```bash
python3 reimbursement.py -i ./我的发票 -o ./报销结果
```

---

## 命令行使用演示

```
╔══════════════════════════════════════╗
║         📋 报销助手                  ║
╚══════════════════════════════════════╝

👉 把发票文件夹拖到这里，按回车：

  ┌──────────────────────────────────────┐
  │ 📂 文件夹: 北京出差发票
  │ 📄 找到 12 个发票文件
  └──────────────────────────────────────┘

📋 请选择处理方式：

   [1] 移动文件（整理后原文件夹清空）
   [2] 复制文件（保留原文件）
   [q] 退出

请输入选项 [1/2/q]: 2

⏳ 开始处理...

[1/12] 处理: didi_receipt.jpg
  - OCR 识别中...
  - 分析发票内容...
  - 结果: [打车票] 凭证 | 滴滴出行 | ¥35.00

...

✅ 处理完成！

==================================================
处理完成！汇总如下：
==================================================
  打车票: 4 张, ¥186.50
  火车飞机票: 2 张, ¥1,256.00
  住宿费: 3 张, ¥897.00
  餐费: 2 张, ¥156.00
--------------------------------------------------
  总计: ¥2,495.50
==================================================

┌──────────────────────────────────────┐
│ [o] 打开结果文件夹                   │
│ [e] 打开Excel报表                    │
│ [q] 退出                             │
└──────────────────────────────────────┘
```

---

## 输出结果

### 文件夹结构

```
北京出差发票_报销结果_20241214_120000/
│
├── 打车票/
│   ├── 2024-01-15_滴滴出行_35.00元/
│   │   ├── 01_2024-01-15_凭证_滴滴出行_35.00元_望京-三里屯.jpg
│   │   └── 02_2024-01-15_发票_滴滴出行_35.00元.pdf
│   └── 2024-01-16_高德打车_42.50元/
│       └── 2024-01-16_发票_高德打车_42.50元.pdf
│
├── 火车飞机票/
│   └── 2024-01-14_12306_628.00元/
│       └── 2024-01-14_发票_12306_628.00元_北京南-上海虹桥.pdf
│
├── 住宿费/
│   └── 2024-01-15_全季酒店_299.00元/
│       └── 2024-01-15_发票_全季酒店_299.00元.pdf
│
├── 餐费/
│   └── ...
│
├── 其他/
│   └── ...
│
└── 报销统计_20241214_120000.xlsx   ← 汇总报表
```

### Excel 报表内容

**汇总表**

| 类别 | 发票数量 | 金额（元） |
|:---|:---:|---:|
| 打车票 | 4 | 186.50 |
| 火车飞机票 | 2 | 1,256.00 |
| 住宿费 | 3 | 897.00 |
| 餐费 | 2 | 156.00 |
| **合计** | **11** | **2,495.50** |

**明细表（每个类别一个 Sheet）**

| 序号 | 日期 | 商家/平台 | 金额 | 发票号码 | 类型 | 文件路径 |
|:---:|:---|:---|---:|:---|:---:|:---|
| 1 | 2024-01-15 | 滴滴出行 | 35.00 | 12345678 | 发票 | 打车票/... |
| 2 | 2024-01-16 | 高德打车 | 42.50 | 23456789 | 发票 | 打车票/... |

---

## 命令行参数

```bash
python3 reimbursement.py [选项]
```

| 参数 | 简写 | 说明 | 示例 |
|:---|:---:|:---|:---|
| `--input` | `-i` | 发票文件夹路径 | `-i ./发票` |
| `--output` | `-o` | 输出目录路径 | `-o ./结果` |
| `--copy` | `-c` | 复制而非移动文件 | `-c` |
| `--api-key` | `-k` | 指定 API 密钥 | `-k sk-xxx` |

**示例：**

```bash
# 基本用法
python3 reimbursement.py -i ./发票 -o ./报销结果

# 保留原文件
python3 reimbursement.py -i ./发票 -o ./报销结果 --copy

# 指定 API Key
python3 reimbursement.py -i ./发票 -o ./报销结果 -k sk-xxxx
```

---

## 项目文件说明

```
报销/
├── 启动报销助手.command   # 命令行版启动脚本
├── 启动网页版.command     # 网页版启动脚本
├── reimbursement.py       # 命令行主程序
├── web_app.py             # 网页版主程序 (Flask)
├── config.py              # 配置管理
├── ocr_handler.py         # OCR 文字识别
├── invoice_analyzer.py    # AI 发票分析
├── file_organizer.py      # 文件分类整理
├── report_generator.py    # Excel 报表生成
├── templates/
│   └── index.html         # 网页界面
├── static/
│   └── style.css          # 网页样式
├── requirements.txt       # Python 依赖
├── .env                   # API 密钥配置（自动生成）
└── README.md              # 本文档
```

---

## 常见问题

<details>
<summary><b>Q: 首次运行很慢？</b></summary>

首次运行需要下载 PaddleOCR 模型（约 100MB），请耐心等待。后续运行会很快。
</details>

<details>
<summary><b>Q: 识别不准确怎么办？</b></summary>

- 确保图片清晰、光线充足
- 扫描件比手机拍照效果更好
- 电子 PDF 发票识别率最高
</details>

<details>
<summary><b>Q: 分类错误怎么办？</b></summary>

AI 会根据发票内容智能判断，偶尔可能出错。可以手动将文件移到正确的分类文件夹，不影响报表数据。
</details>

<details>
<summary><b>Q: 支持哪些发票？</b></summary>

- ✅ 增值税电子普通发票
- ✅ 增值税电子专用发票
- ✅ 出租车/网约车行程单和发票
- ✅ 火车票、机票行程单
- ✅ 酒店住宿发票
- ✅ 餐饮发票
- ✅ 其他各类消费发票
</details>

<details>
<summary><b>Q: API 调用失败？</b></summary>

1. 检查 API Key 是否正确（重新运行程序会提示重新配置）
2. 确认网络连接正常
3. 确认硅基流动账户余额充足：https://cloud.siliconflow.cn
</details>

<details>
<summary><b>Q: 如何重新配置 API Key？</b></summary>

删除项目目录下的 `.env` 文件，重新运行程序即可重新配置。
</details>

<details>
<summary><b>Q: 网页版上传的文件安全吗？</b></summary>

非常安全！所有上传的文件都存储在临时目录：
- 下载结果后 **1 分钟内自动删除**
- 即使不下载，**30 分钟后也会自动清理**
- 服务器关闭时会清理所有临时文件
- 文件仅在本地处理，不会上传到任何云端
</details>

<details>
<summary><b>Q: 网页版可以部署到服务器吗？</b></summary>

可以！默认监听 `0.0.0.0:5000`，局域网内其他设备可以通过你的 IP 访问。

如需公网部署，建议：
1. 使用 Nginx 反向代理
2. 配置 HTTPS
3. 添加访问限制（因为 API Key 是共享的）
</details>

<details>
<summary><b>Q: 网页版和命令行版有什么区别？</b></summary>

| 功能 | 网页版 | 命令行版 |
|:---|:---:|:---:|
| 易用性 | 更友好 | 需要终端操作 |
| 文件处理 | 复制模式 | 可选移动/复制 |
| 重新生成报表 | 不支持 | 支持 |
| 批量脚本化 | 不适合 | 适合 |
</details>

---

## 技术栈

- **OCR 引擎**: [PaddleOCR](https://github.com/PaddlePaddle/PaddleOCR) - 百度开源的中文 OCR
- **PDF 处理**: [PyMuPDF](https://pymupdf.readthedocs.io/) - 高性能 PDF 解析
- **AI 分析**: [硅基流动](https://cloud.siliconflow.cn) - 提供 DeepSeek-V3 等多种大模型 API
- **报表生成**: [OpenPyXL](https://openpyxl.readthedocs.io/) - Excel 文件处理
- **Web 框架**: [Flask](https://flask.palletsprojects.com/) - 轻量级 Python Web 框架

---

## 许可证

MIT License - 随便用，不负责

---

> 💡 **小贴士**：第一次使用建议选择「复制文件」模式，确认效果满意后再使用「移动文件」模式。
