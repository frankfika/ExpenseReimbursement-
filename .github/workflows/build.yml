name: CI Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Read version
      id: version
      run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

    - name: Build with PyInstaller
      run: |
        pyinstaller --clean --onefile --windowed \
          --name "ExpenseHelper" \
          --add-data "web/templates:web/templates" \
          --add-data "web/static:web/static" \
          --hidden-import webview \
          --hidden-import flask \
          --hidden-import paddleocr \
          --exclude-module tkinter \
          --exclude-module matplotlib \
          --exclude-module test \
          --exclude-module unittest \
          --exclude-module pydoc \
          --exclude-module argparse \
          --exclude-module http.server \
          --exclude-module ssl \
          --strip \
          --optimize 2 \
          desktop_app.py

    - name: Create DMG
      run: |
        APP_NAME="ExpenseHelper"
        VERSION="${{ steps.version.outputs.VERSION }}"
        DMG_NAME="ExpenseHelper-${VERSION}-macos"
        TEMP_DIR="dist/dmg_temp"
        DMG_TEMP_DIR="dist/dmg_mount"

        mkdir -p "$TEMP_DIR"
        cp -R "dist/${APP_NAME}.app" "$TEMP_DIR/"
        ln -s /Applications "$TEMP_DIR/Applications"

        # Create temporary DMG
        hdiutil create -volname "ExpenseHelper" \
          -srcfolder "$TEMP_DIR" \
          -ov -format UDRW \
          "dist/${DMG_NAME}_temp.dmg"

        # Mount and set Finder view
        mkdir -p "$DMG_TEMP_DIR"
        hdiutil attach "dist/${DMG_NAME}_temp.dmg" -mountpoint "$DMG_TEMP_DIR" -nobrowse -quiet

        # Use AppleScript to set Finder view
        osascript <<'EOF'
tell application "Finder"
  tell disk "ExpenseHelper"
    open
    set current view of container window to icon view
    set toolbar visible of container window to false
    set statusbar visible of container window to false
    set the bounds of container window to {400, 100, 900, 450}
    set viewOptions to the icon view options of container window
    set arrangement of viewOptions to not arranged
    set icon size of viewOptions to 72
    set position of item "ExpenseHelper.app" of container window to {125, 175}
    set position of item "Applications" of container window to {375, 175}
    close
    update without registering applications
    delay 2
  end tell
end tell
EOF

        # Unmount and compress
        sync
        hdiutil detach "$DMG_TEMP_DIR" -quiet

        hdiutil convert "dist/${DMG_NAME}_temp.dmg" \
          -format UDZO \
          -imagekey zlib-level=9 \
          -o "dist/${DMG_NAME}.dmg"

        # Cleanup
        rm -f "dist/${DMG_NAME}_temp.dmg"
        rm -rf "$TEMP_DIR" "$DMG_TEMP_DIR"

    - name: Upload DMG
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg
        path: dist/ExpenseHelper-*.dmg
        retention-days: 7

  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Read version
      id: version
      run: echo "VERSION=$(cat VERSION)" >> $env:GITHUB_OUTPUT

    - name: Build with PyInstaller
      run: |
        $VERSION = "${{ steps.version.outputs.VERSION }}"
        pyinstaller --clean --onefile --windowed `
          --name "ExpenseHelper" `
          --add-data "web/templates;web/templates" `
          --add-data "web/static;web/static" `
          --hidden-import webview `
          --hidden-import flask `
          --hidden-import paddleocr `
          --exclude-module tkinter `
          --exclude-module matplotlib `
          --exclude-module test `
          --exclude-module unittest `
          --exclude-module pydoc `
          --exclude-module argparse `
          --exclude-module http.server `
          --exclude-module ssl `
          --strip `
          --optimize 2 `
          desktop_app.py

    - name: Rename with version
      run: |
        $VERSION = "${{ steps.version.outputs.VERSION }}"
        Move-Item "dist\ExpenseHelper.exe" "dist\ExpenseHelper-$VERSION-windows.exe"

    - name: Upload EXE
      uses: actions/upload-artifact@v4
      with:
        name: windows-exe
        path: dist/ExpenseHelper-*.exe
        retention-days: 7
